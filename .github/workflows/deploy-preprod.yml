name: Deploy to Pre-Prod (Docker)

on:
    push:
        branches:
            - preprod # Se d√©clenche quand une PR est merg√©e vers preprod
    pull_request:
        branches:
            - preprod # Lint uniquement pour valider la PR avant merge
    workflow_dispatch:

jobs:
    lint:
        name: Lint Code
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.12.4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24.3"
                  cache: "pnpm"
                  cache-dependency-path: "frontend/pnpm-lock.yaml"

            - name: Install frontend dependencies
              working-directory: ./frontend
              run: pnpm install --frozen-lockfile

            - name: Lint frontend
              working-directory: ./frontend
              run: pnpm lint

    deploy:
        name: Deploy preprod to VPS with Docker
        needs: lint
        if: github.event_name == 'push' && github.ref == 'refs/heads/preprod'
        runs-on: ubuntu-latest
        steps:
            - name: Deploy to VPS
              uses: appleboy/ssh-action@master
              env:
                  DEPLOY_PATH: ${{ secrets.DEPLOY_PREPROD_PATH }}
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USERNAME }}
                  key: ${{ secrets.SSH_KEY }}
                  envs: DEPLOY_PATH
                  script: |
                      set -e
                      echo "üöÄ Starting Docker deployment..."

                       cd ~/docker/sites/preprod/flepourtous || { echo "‚ùå Project directory not found"; exit 1; }

                      echo "üì• Pulling latest changes from preprod..."
                      git fetch origin preprod
                      git reset --hard origin/preprod

                      echo "üîç Linting backend code..."
                      docker compose -f docker-compose.yml -f docker-compose.preprod.yml run --rm backend composer check-style || echo "‚ö†Ô∏è Backend lint warnings (non-blocking)"

                      echo "üî® Building and restarting containers..."
                      make preprod

                      echo "üßπ Cleaning up old Docker images..."
                      docker image prune -f

                      echo "‚úÖ Deployment complete!"
                      echo "üìä Container status:"
                      docker compose -f docker-compose.yml -f docker-compose.preprod.yml ps
